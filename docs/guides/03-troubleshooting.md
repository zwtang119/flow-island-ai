# 第三部分：使用与故障排查

本部分提供了项目的日常使用说明，以及针对常见问题的解决方案。

---

## **基本操作 (Basic Operation)**

### 硬件按钮功能

Watchy 设备侧面有四个物理按钮，其功能定义如下：

*   **SW1 (左下): 菜单/确认 (Menu/Confirm)**
*   **SW2 (左上): 取消/返回 (Cancel/Back)**
*   **SW3 (右上): 上 (Up)**
*   **SW4 (右下): 下 (Down)**

### 手动同步便利贴

尽管手表会按预设周期自动更新，您也可以随时手动触发一次同步：

1.  **通过菜单 (推荐)**:
    *   按下 **SW1 (菜单)** 按钮进入系统菜单。
    *   使用 **SW3 (上)** / **SW4 (下)** 导航至 `Update` 或 `Refresh` 类似的选项。
    *   按下 **SW1 (确认)** 触发更新。
    *   *(注: 菜单选项可能因固件版本而异。)*

2.  **通过重启**:
    *   使用 USB 数据线将手表与电脑断开再重新连接，即可强制重启设备并立即触发一次同步。

---

## **初始系统检查**

在深入排查问题之前，请先执行此项快速检查，它可以验证您的服务器和Web UI是否正常工作。

1.  确保您的本地服务器正在运行。
2.  在**手机或电脑的浏览器**中，访问您在固件中配置的 `IMAGE_URL` 地址（例如 `http://192.168.1.10:3000/api/image`）。
3.  观察结果：
    *   **✅ 成功**: 浏览器直接**显示**了一张便利贴图片。这证明您的服务器已正确运行，且图像已成功生成并缓存。如果此时手表依然无法显示，问题很可能出在 **Wi-Fi 连接**或**固件配置**上。
    *   **❌ 失败**: 浏览器显示 "No image available." 或 "404 Not Found"。这表示您还未在 Web UI (`http://localhost:3000`) 中成功生成第一张便利贴。请先完成一次语音备忘录的生成。
    *   **❌ 失败**: 浏览器显示“无法访问此网站”或长时间无响应。这表明您的设备无法访问本地服务器，请直接跳至下方的 `ERROR: Server Conn Failed` 排查指南。

---

## **手表显示错误**

### 🚨 `ERROR: Server Conn Failed`

此错误表示 Watchy 设备已成功连接至 Wi-Fi，但无法访问本地服务器。这是最常见的问题，通常由IP地址配置错误导致。请按以下顺序排查：

#### 1. 验证 IP 地址 (最常见原因)
*   **服务器地址列表**: 检查运行本地服务器的终端窗口。新版服务器会列出所有检测到的 `LAN Access` 地址，例如：
    ```
    > LAN Access (Choose the correct one for your network):
        - http://172.23.48.1:3000
        - http://192.168.137.1:3000
    ```
*   **选择正确的IP**:
    *   如果您的电脑和 Watchy 都连接到同一个 Wi-Fi 路由器，请选择您的电脑在该 Wi-Fi 网络下的 IP (通常是 `192.168.x.x` 或 `10.0.x.x`)。
    *   如果您使用的是**电脑创建的移动热点**，请选择热点对应的 IP (通常是 `192.168.137.1`)。
    *   请忽略任何虚拟网卡（如 WSL、VPN、Docker）的 IP 地址。
*   **固件配置**: 在 Arduino IDE 中打开固件代码，检查 `IMAGE_URL` 常量的值。
*   **比对**: 确保固件中配置的 IP 地址与您选择的**正确地址完全匹配**。如果不匹配，请修正固件代码并**重新上传**。

#### 2. 确认服务器运行状态
*   用于启动服务器的终端窗口必须保持运行状态。关闭该窗口将终止服务器进程。

#### 3. 检查主机防火墙
*   计算机的防火墙（如 Windows Defender Firewall）可能会阻止来自局域网其他设备（如 Watchy）的入站连接。
*   **解决方案**:
    *   当首次运行服务器时，操作系统可能会弹出安全警报。请允许 "Node.js" 或 "node" 应用访问网络（特别是“专用网络”）。
    *   如果错过了警报，请手动在防火墙设置中为 `Node.js JavaScript Runtime` 创建一条**入站规则 (Inbound Rule)**，允许 `TCP 端口 3000` 上的连接。

#### 4. 检查网络环境
*   确认 Watchy 设备和运行服务器的计算机连接到**同一个 Wi-Fi 网络**。
*   **高级**: 检查路由器的 **“AP 隔离 (AP Isolation)”** 或 **“客户端隔离”** 功能是否已禁用。该功能会阻止同一网络下的设备互相通信。

---

## **常见使用问题**

### ⚠️ **为什么手表离开家后，时间就不动了？**
- **原因**: 这是当前版本的一个**已知技术限制**。为了实现“零固件修改”并快速迭代，我们将时间的绘制任务放在了服务器端。这意味着，手表必须通过Wi-Fi连接到您的本地服务器，才能获取一张带有**最新时间**的图片。
- **当前行为**: 当手表离开Wi-Fi范围，它无法进行网络请求，因此屏幕会一直显示**最后一次成功同步时**的画面，包括当时的时间。
- **未来规划**: 这个问题的根本解决方案是在未来的固件更新中，将时间绘制的逻辑移回到手表设备本身。在当前的MVP（最小可行产品）阶段，我们接受这个限制，以换取更快的开发速度和更简单的部署流程。

---

## **固件编译与上传问题**

### 上传失败: `开发板在 null 不可用` (Board at null is not available)

此错误表示 Arduino IDE 无法检测到连接的 Watchy 设备。

1.  **检查 USB 数据线**: 确保使用的 USB-C 线缆支持数据传输，而不仅仅是充电。
2.  **检查 IDE 端口**: 确认在 `工具 > 端口` 菜单中已选择了正确的串口 (例如 `COM3` 或 `/dev/cu.usbserial-xxxx`)。
3.  **安装串口驱动**:
    *   **CP210x 芯片**: [下载 Silicon Labs 官方驱动](https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers)
    *   **CH9102 芯片**: [下载 WCH 官方驱动](https://www.wch.cn/downloads/CH341SER_EXE.html)
    *   安装驱动后，重启 Arduino IDE 并重新检查端口。
4.  **强制进入 Bootloader 模式**:
    1.  按住手表左侧的**左下角按钮 (Back/Down)**。
    2.  在按住的同时，通过 USB 连接手表到计算机。
    3.  等待数秒后松开按钮。IDE 应能稳定识别端口，此时可重新上传。

### 编译失败: `PNG_LITTLE_ENDIAN` 未定义

此错误由不正确的库或开发板核心版本导致。

1.  **`PNGdec` 库版本**: 确保已安装 **`1.0.2`** 版本的 `PNGdec` 库。
2.  **`esp32` 开发板核心版本**: 确保已安装 **`2.0.17`** 版本的 `esp32` 开发板核心。

### 编译失败: `'GPIO_SEL_32' was not declared in this scope`

此错误明确表示安装了不兼容的 `arduino-esp32` 开发板核心版本。

*   **解决方案**: 请严格遵循安装指南，确保在 `开发板管理器` 中安装的 `esp32` 版本为 **`2.0.17`**。

### 编译失败: `'cannot bind non-const lvalue reference...'`

此错误由不兼容的 `DS3232RTC` 库版本导致。

*   **解决方案**: 请严格遵循安装指南，确保已安装 **`2.0.1`** 版本的 `DS3232RTC` 库。

### 上传失败或设备无响应

此问题通常与 USB 端口供电稳定性有关。

*   **首选方案**: 尝试使用**笔记本电脑**进行刷写，其 USB 端口供电通常更稳定。
*   **备用方案**: 在 Arduino IDE 的 `工具 > Upload Speed` 菜单中，将速率**降至 `115200`**。

### Linux 系统上传失败: `Permission denied`

这是典型的 Linux 串口权限问题。

*   **解决方案**: 在终端中执行以下命令，将当前用户添加到 `dialout` 组：
    ```bash
    sudo usermod -a -G dialout $USER
    ```
*   **重要**: 执行命令后，必须**注销并重新登录**或重启计算机以使权限生效。

---

## **Web UI 浏览器问题**

### `ERROR: Server connection timed out.`
*   **原因 1**: 本地服务器未运行。请检查终端窗口。
*   **原因 2**: 防火墙拦截。请检查主机防火墙设置，确保 `Node.js` 的入站连接被允许。

### `ERROR: not-allowed`
这是由浏览器的安全策略（Secure Contexts）导致的。

*   **解决方案**: 必须在**运行服务器的同一台计算机上**，通过 `http://localhost:3000` 地址访问 Web UI。`localhost` 被浏览器视为安全上下文，允许使用麦克风等敏感 API。

### AI 请求失败 (`Network Error`) 与 VPN 配置
如果您在手机等设备上使用 Web UI，并且该设备需要通过 VPN 才能访问互联网 (以及 Gemini API)，可能会遇到网络错误。

*   **症状**: 录音和语音识别正常，但在 AI 处理阶段，状态栏显示 `ERROR: AI request timed out.` 或类似的 `Network Error`。
*   **原因**: 您 VPN 的“全局模式”会将所有流量（包括对本地服务器的访问）都路由到远程VPN服务器，导致无法连接本地服务器。
*   **解决方案**: 必须将您的 VPN 应用设置为 **“绕开局域网 (Bypass LAN)”** 或 **“分割隧道 (Split Tunneling)”** 模式。这可以确保：
    1.  访问 **Gemini API** 的流量通过 **VPN**。
    2.  访问**本地服务器** (`http://<your_local_ip>:3000`) 的流量**不通过** VPN，而是直接在局域网内通信。

---

## **设备恢复**

### 卡在 `Watch BLE OTA Waiting for connection...` 屏幕

此状态无法通过设备按键退出。

*   **解决方案**: 唯一的恢复方法是通过 USB 数据线将设备连接到计算机，并按照**第二部分**的指南重新刷写固件。

### 其他固件上传方法

如果 USB 连接存在问题，可尝试通过 Web Bluetooth 刷写官方固件以恢复设备。

1.  在 Watchy 设备上，导航至 `Menu > Update Firmware > Update`。
2.  在计算机上，使用 **Google Chrome** 或 **Microsoft Edge** 浏览器访问 Watchy 官方刷写站点：[https://watchy.sqfmi.com/watchfaces](https://watchy.sqfmi.com/watchfaces)
3.  按照网站提示完成配对和刷写。

*注：此方法主要用于刷写官方固件，可作为验证硬件功能或恢复设备的手段。*