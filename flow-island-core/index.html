
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒæµé™å²› (Flow Island) - é…ç½®ä¸­å¿ƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Condensed:wght@400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #FFFFFF;
            --bg-subtle: #F7F7FF;
            --text-main: #000000;
            --text-subtle: #555555;
            --border-main: #DDDDDD;
            --button-primary-bg: #000000;
            --button-primary-text: #FFFFFF;
            --q1-color: #D32F2F;
            --q2-color: #388E3C;
            --q3-color: #FBC02D;
            --q4-color: #7B1FA2;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-subtle);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }
        
        .root-container {
            width: 100%;
            max-width: 900px;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-main);
            margin-bottom: 30px;
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-subtle);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .tab-button.active {
            color: var(--text-main);
            border-bottom-color: var(--text-main);
        }
        
        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .main-container {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 300px 1fr;
                gap: 40px;
            }
        }

        .preview-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .device-preview {
            position: sticky;
            top: 30px;
            width: 250px;
            height: 250px;
            background: #EFEFEF;
            border: 1px solid var(--border-main);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px;
            box-sizing: border-box;
        }
        
        .device-preview canvas {
            width: 200px;
            height: 200px;
            background-color: var(--bg-main);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .config-column, .showcase-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .card {
            background: var(--bg-main);
            border: 1px solid var(--border-main);
            border-radius: 8px;
            padding: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .card h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .clear-button {
            background: none;
            border: none;
            color: var(--text-subtle);
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }
        .clear-button:hover {
            color: var(--q1-color);
        }

        .action-button {
            display: block;
            width: 100%;
            text-align: center;
            background-color: var(--button-primary-bg);
            color: var(--button-primary-text);
            border: 1px solid var(--button-primary-bg);
            border-radius: 6px;
            padding: 12px 20px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, background-color 0.2s;
            user-select: none; /* Prevent text selection on hold */
        }
        
        .action-button.recording {
             background-color: var(--q1-color);
             border-color: var(--q1-color);
        }

        .action-button:hover:not(:disabled) {
            opacity: 0.8;
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-text {
            margin-top: 15px;
            font-size: 13px;
            min-height: 1.2em;
            line-height: 1.4;
            color: var(--text-subtle);
        }
        
        .agenda-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 600px) {
            .agenda-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .quadrant-box {
            padding-top: 15px;
        }

        .quadrant-box h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid;
        }

        #quadrant-1 h3, .quadrant-1 h3 { border-color: var(--q1-color); }
        #quadrant-2 h3, .quadrant-2 h3 { border-color: var(--q2-color); }
        #quadrant-3 h3, .quadrant-3 h3 { border-color: var(--q3-color); }
        #quadrant-4 h3, .quadrant-4 h3 { border-color: var(--q4-color); }
        
        .agenda-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 14px;
            color: var(--text-main);
        }

        .agenda-item {
            padding: 6px 0;
            font-family: 'Roboto Condensed', monospace;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .agenda-item-text {
             flex-grow: 1;
             margin-right: 8px;
        }
        
        .agenda-item .time {
            font-weight: 600;
            margin-right: 6px;
        }
        
        .agenda-item .date-label {
            color: var(--text-subtle);
            font-size: 12px;
            margin-right: 6px;
        }

        .delete-button {
            cursor: pointer;
            color: var(--text-subtle);
            font-weight: bold;
            padding: 0 5px;
            opacity: 0.5;
        }
        .delete-button:hover {
            color: var(--q1-color);
            opacity: 1;
        }

        .persona-card {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 500px) {
            .persona-card {
                grid-template-columns: 200px 1fr;
                align-items: center;
            }
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="root-container">
        <nav class="tab-nav">
            <button class="tab-button active" data-tab="user-panel">é…ç½®ä¸­å¿ƒ</button>
            <button class="tab-button" data-tab="showcase-panel">åŠŸèƒ½æ¼”ç¤º</button>
        </nav>

        <div id="user-panel" class="tab-panel active">
            <div class="main-container">
                <div class="preview-column">
                    <div class="device-preview">
                        <canvas id="livePreviewCanvas" width="200" height="200"></canvas>
                    </div>
                </div>
                <div class="config-column">
                    <div class="card">
                        <h2>è¯­éŸ³æ·»åŠ æ—¥ç¨‹</h2>
                        <button class="action-button" id="recordButton">ç‚¹å‡»å¼€å§‹å½•éŸ³</button>
                        <p id="statusText" class="status-text">è¯´å‡ºæ‚¨çš„æ—¥ç¨‹å®‰æ’ï¼Œä¾‹å¦‚ï¼šâ€œæ˜å¤©ä¸Šåˆ10ç‚¹å’Œå®¢æˆ·å¼€ä¼šï¼Œä¸‹åˆ3ç‚¹å»å¥èº«â€</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                           <h2>æˆ‘çš„æ—¥ç¨‹ (AI è‡ªåŠ¨åˆ†ç±»)</h2>
                           <button id="clearAgendaButton" class="clear-button">[æ¸…ç©ºæ—¥ç¨‹]</button>
                        </div>
                        <div class="agenda-grid" id="agenda-grid-container">
                            <div id="quadrant-1" class="quadrant-box">
                                <h3>ğŸ”´ é‡è¦ä¸”ç´§æ€¥</h3>
                                <ul class="agenda-list" data-quadrant="1"></ul>
                            </div>
                            <div id="quadrant-2" class="quadrant-box">
                                <h3>ğŸŸ¢ é‡è¦ä¸ç´§æ€¥</h3>
                                <ul class="agenda-list" data-quadrant="2"></ul>
                            </div>
                            <div id="quadrant-3" class="quadrant-box">
                                <h3>ğŸŸ¡ ç´§æ€¥ä¸é‡è¦</h3>
                                <ul class="agenda-list" data-quadrant="3"></ul>
                            </div>
                            <div id="quadrant-4" class="quadrant-box">
                                <h3>ğŸŸ£ ä¸é‡è¦ä¸ç´§æ€¥</h3>
                                <ul class="agenda-list" data-quadrant="4"></ul>
                            </div>
                        </div>
                        <p id="agendaStatus" class="status-text">æš‚æ— æ—¥ç¨‹ã€‚è¯·é€šè¿‡è¯­éŸ³æ·»åŠ ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="showcase-panel" class="tab-panel">
            <div class="showcase-column" id="showcase-container">
                <!-- Showcase content will be dynamically generated by JavaScript -->
            </div>
        </div>
    </div>

    <script src="/env.js"></script>
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";
        
        const personaData = {
            li_xiangyu: {
                name: "æç¿”å®‡ - AIé«˜çº§å·¥ç¨‹å¸ˆ",
                tasks: [
                    {"uid":"persona-v2-q1-001","time":"09:30","summary":"å‘Davidæ±‡æŠ¥NLUIè°ƒåº¦ç³»ç»Ÿå»¶è¿Ÿé—®é¢˜","quadrant":1, "start": "2024-10-26T09:30:00Z"},
                    {"uid":"persona-v2-q1-002","time":"14:00","summary":"å¤„ç†çº¿ä¸ŠæœåŠ¡P0æ•…éšœ (LLM-é«˜å¾·åœ°å›¾API)","quadrant":1, "start": "2024-10-26T14:00:00Z"},
                    {"uid":"persona-v2-q2-001","time":"å¾…åŠ","summary":"AIä¸»æ¿V3æ ¸å¿ƒèŠ¯ç‰‡é€‰å‹","quadrant":2, "start": "2024-10-27T09:00:00Z"},
                ].sort((a, b) => new Date(a.start) - new Date(b.start))
            },
            tang_zhiwei: {
                name: "å”å¿—ä¼Ÿ - AIåšå£«ç ”ç©¶ç”Ÿ",
                tasks: [
                    {"uid":"persona-phd-q1-001","time":"23:59","summary":"NeurIPS 2025è®ºæ–‡æœ€ç»ˆç‰ˆæäº¤æˆªæ­¢","quadrant":1, "start": "2024-11-05T23:59:00Z"},
                    {"uid":"persona-phd-q1-002","time":"10:00","summary":"ä¸å¼ è¾‰æ•™æˆç´§æ€¥è®¨è®ºå®éªŒæ•°æ®é—®é¢˜","quadrant":1, "start": "2024-10-26T10:00:00Z"},
                    {"uid":"persona-phd-q2-001","time":"19:00","summary":"å‡†å¤‡å‘¨å››Agentè¯¾é¢˜ç»„çš„ç»„ä¼šæŠ¥å‘Š","quadrant":2, "start": "2024-10-29T19:00:00Z"},
                ].sort((a, b) => new Date(a.start) - new Date(b.start))
            },
            chen_yalin: {
                name: "é™ˆé›…ç³ - å¸‚åœºè¿è¥è´Ÿè´£äºº",
                tasks: [
                     {"uid":"persona-mkt-q1-001","time":"10:00","summary":"ä¸CEOç´§æ€¥å¤ç›˜å°çº¢ä¹¦é¢„çƒ­ç¬”è®°æ•°æ®","quadrant":1, "start": "2024-11-12T10:00:00Z"},
                     {"uid":"persona-mkt-q2-001","time":"å¾…åŠ","summary":"è§„åˆ’Q1å¸‚åœºå®£å‘ç­–ç•¥","quadrant":2, "start": "2024-11-13T09:30:00Z"},
                     {"uid":"persona-mkt-q2-002","time":"14:00","summary":"ä¸æ ¸å¿ƒKOLæ¸ é“ä¼™ä¼´æ•²å®šå¹´åº¦åˆä½œ","quadrant":2, "start": "2024-11-12T14:00:00Z"},
                ].sort((a, b) => new Date(a.start) - new Date(b.start))
            }
        };

        const LAYOUT = {
            W: 200, H: 200, PADDING: 12,
            TODO_BAR:   { Y: 0,   H: 50, FONT: "400 14px 'Inter', sans-serif", LINE_HEIGHT: 18, MAX_LINES: 2 },
            FOCUS_ZONE: { Y: 51,  H: 98,
                TIME:    { Y: 59, FONT: "700 24px 'Inter', sans-serif" },
                SUMMARY: { Y: 88, FONT: "600 22px 'Inter', sans-serif", LINE_HEIGHT: 26, MAX_LINES: 2 }
            },
            CONTEXT_ZONE: { Y: 150, H: 50, FONT: "400 14px 'Inter', sans-serif", LINE_HEIGHT: 18, MAX_LINES: 2 },
            EMPTY_STATE: { Y: 100, FONT: "600 18px 'Inter', sans-serif" }
        };

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabPanels.forEach(panel => {
                    panel.classList.toggle('active', panel.id === button.dataset.tab);
                });
            });
        });

        const recordButton = document.getElementById('recordButton');
        const statusText = document.getElementById('statusText');
        const livePreviewCanvas = document.getElementById('livePreviewCanvas');
        const agendaStatus = document.getElementById('agendaStatus');
        const clearAgendaButton = document.getElementById('clearAgendaButton');
        const agendaGridContainer = document.getElementById('agenda-grid-container');
        const showcaseContainer = document.getElementById('showcase-container');
        const quadrantLists = {
            1: document.querySelector('.agenda-list[data-quadrant="1"]'),
            2: document.querySelector('.agenda-list[data-quadrant="2"]'),
            3: document.querySelector('.agenda-list[data-quadrant="3"]'),
            4: document.querySelector('.agenda-list[data-quadrant="4"]'),
        };
        
        let ai;
        let recognition;
        let finalTranscript = '';
        let taskWarehouse = [];
        let isRecording = false;
        let recordingTimeoutId = null;
        const TASKS_STORAGE_KEY = 'flowIslandTasks';
        
        function withTimeout(promise, ms, errorMessage = 'æ“ä½œè¶…æ—¶ã€‚') {
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error(errorMessage)), ms);
            });
            return Promise.race([promise, timeoutPromise]);
        }
        
        function updateButtonState(text, disabled = false, recording = false) {
            recordButton.textContent = text;
            recordButton.disabled = disabled;
            recordButton.classList.toggle('recording', recording);
        }

        function updateStatus(message = '', isError = false) {
            statusText.textContent = message;
            statusText.style.color = isError ? 'var(--q1-color)' : 'var(--text-subtle)';
        }

        function loadTasksFromStorage() {
            try {
                const storedTasks = localStorage.getItem(TASKS_STORAGE_KEY);
                return storedTasks ? JSON.parse(storedTasks) : [];
            } catch (e) { console.error("Failed to load tasks", e); return []; }
        }

        function saveTasksToStorage(tasks) {
            try {
                localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(tasks));
            } catch (e) { console.error("Failed to save tasks", e); }
        }
        
        function getRelativeDateLabel(dateString) {
            if (!dateString) return '';
            const now = new Date();
            const eventDate = new Date(dateString);

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());

            const diffTime = eventDay - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return '(ä»Šå¤©)';
            if (diffDays === 1) return '(æ˜å¤©)';
            if (diffDays > 1) return `(${(eventDate.getMonth() + 1)}æœˆ${eventDate.getDate()}æ—¥)`;
            return ''; // Don't show labels for past events in this context
        }

        function renderMyAgenda(tasks) {
            Object.values(quadrantLists).forEach(list => list.innerHTML = '');
            if (!tasks || tasks.length === 0) {
                agendaStatus.textContent = 'æš‚æ— æ—¥ç¨‹ã€‚è¯·é€šè¿‡è¯­éŸ³æ·»åŠ ã€‚';
                return;
            }
            agendaStatus.textContent = `å½“å‰ä»“åº“å…± ${tasks.length} æ¡æ—¥ç¨‹ã€‚`;
            
            const sortedTasks = [...tasks].sort((a,b) => new Date(a.start) - new Date(b.start));

            sortedTasks.forEach(task => {
                if (quadrantLists[task.quadrant]) {
                    const listItem = document.createElement('li');
                    listItem.className = 'agenda-item';
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'agenda-item-text';
                    
                    const dateLabel = (task.time !== 'å¾…åŠ') ? getRelativeDateLabel(task.start) : '';
                    
                    textSpan.innerHTML = `<span class="time">${task.time}</span> <span class="date-label">${dateLabel}</span> ${task.summary}`;

                    const deleteSpan = document.createElement('span');
                    deleteSpan.className = 'delete-button';
                    deleteSpan.textContent = 'Ã—';
                    deleteSpan.title = 'åˆ é™¤æ­¤æ—¥ç¨‹';
                    deleteSpan.dataset.taskId = task.id;

                    listItem.appendChild(textSpan);
                    listItem.appendChild(deleteSpan);
                    quadrantLists[task.quadrant].appendChild(listItem);
                }
            });
        }
        
        function selectEventsForDisplay(tasks) {
            if (!tasks || tasks.length === 0) {
                return { focus: null, context: null, todo: null };
            }
            const now = new Date();
            const futureEvents = tasks.filter(e => new Date(e.start) > now || e.time === "å¾…åŠ");
            
            const importantTimedEvents = futureEvents
                .filter(e => e.time !== "å¾…åŠ" && (e.quadrant === 1 || e.quadrant === 2))
                .sort((a, b) => new Date(a.start) - new Date(b.start));

            const importantTodoEvents = futureEvents
                .filter(e => e.time === "å¾…åŠ" && (e.quadrant === 1 || e.quadrant === 2))
                .sort((a, b) => new Date(a.start) - new Date(b.start));

            const focusEvent = importantTimedEvents[0] || null;
            const contextEvent = importantTimedEvents[1] || null;
            const todoEvent = importantTodoEvents[0] || null;
            
            return { focus: focusEvent, context: contextEvent, todo: todoEvent };
        }

        function _getWrappedLines(ctx, text, maxWidth) {
            const lines = [];
            if (!text) return lines;
            let currentLine = '';
            for (const char of text) {
                const testLine = currentLine + char;
                if (ctx.measureText(testLine).width > maxWidth && currentLine !== '') {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine) lines.push(currentLine);
            return lines;
        }
        
        async function renderImageOnCanvas(canvas, tasks) {
            const { focus, context, todo } = selectEventsForDisplay(tasks);
            const ctx = canvas.getContext('2d');

            await document.fonts.ready;
            ctx.imageSmoothingEnabled = false;

            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, LAYOUT.W, LAYOUT.H);
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';

            if (todo) {
                ctx.font = LAYOUT.TODO_BAR.FONT;
                const text = `å¾…åŠ: ${todo.summary}`;
                const lines = _getWrappedLines(ctx, text, LAYOUT.W - LAYOUT.PADDING * 2).slice(0, LAYOUT.TODO_BAR.MAX_LINES);
                const totalTextHeight = lines.length * LAYOUT.TODO_BAR.LINE_HEIGHT;
                const startY = LAYOUT.TODO_BAR.Y + (LAYOUT.TODO_BAR.H - totalTextHeight) / 2;
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], LAYOUT.PADDING, startY + (i * LAYOUT.TODO_BAR.LINE_HEIGHT));
                }
            }

            if (focus) {
                ctx.font = LAYOUT.FOCUS_ZONE.TIME.FONT;
                ctx.fillText(focus.time, LAYOUT.PADDING, LAYOUT.FOCUS_ZONE.TIME.Y);

                ctx.font = LAYOUT.FOCUS_ZONE.SUMMARY.FONT;
                const lines = _getWrappedLines(ctx, focus.summary, LAYOUT.W - LAYOUT.PADDING * 2).slice(0, LAYOUT.FOCUS_ZONE.SUMMARY.MAX_LINES);
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], LAYOUT.PADDING, LAYOUT.FOCUS_ZONE.SUMMARY.Y + (i * LAYOUT.FOCUS_ZONE.SUMMARY.LINE_HEIGHT));
                }
            } else {
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = LAYOUT.EMPTY_STATE.FONT;
                ctx.fillText("äº«å—æ‚¨çš„å¿ƒæµæ—¶é—´", LAYOUT.W / 2, LAYOUT.EMPTY_STATE.Y);
            }

            if (context) {
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.font = LAYOUT.CONTEXT_ZONE.FONT;
                const text = `ç¨å: ${context.time} ${context.summary}`;
                const lines = _getWrappedLines(ctx, text, LAYOUT.W - LAYOUT.PADDING * 2).slice(0, LAYOUT.CONTEXT_ZONE.MAX_LINES);
                const totalTextHeight = lines.length * LAYOUT.CONTEXT_ZONE.LINE_HEIGHT;
                const startY = LAYOUT.CONTEXT_ZONE.Y + (LAYOUT.CONTEXT_ZONE.H - totalTextHeight) / 2;
                for (let i = 0; i < lines.length; i++) {
                     ctx.fillText(lines[i], LAYOUT.PADDING, startY + (i * LAYOUT.CONTEXT_ZONE.LINE_HEIGHT));
                }
            }

            return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        }

        async function updateUIAndSync(tasks) {
            renderMyAgenda(tasks);
            
            updateStatus('æ­£åœ¨ç”Ÿæˆæ‰‹è¡¨é¢„è§ˆ...');
            try {
                const imageBlob = await renderImageOnCanvas(livePreviewCanvas, tasks);
                updateStatus('æ­£åœ¨åŒæ­¥åˆ°æœåŠ¡å™¨...');
                await sendImageToServer(imageBlob);
                updateStatus('æ—¥ç¨‹å·²æ›´æ–°ã€‚');
            } catch (err) {
                updateStatus(`é”™è¯¯: ${err.message}`, true);
            }
        }

        async function processTranscript(text) {
            updateStatus('æ­£åœ¨ç”¨ AI åˆ†ææ‚¨çš„æ—¥ç¨‹...');
            try {
                const aiPromise = ai.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: `è¯·ä¸ºæˆ‘åˆ†æå¹¶åˆ†ç±»ä»¥ä¸‹è¯­éŸ³å†…å®¹ï¼šâ€œ${text}â€`,
                    config: {
                        systemInstruction: `ä½ æ˜¯ä¸€ä¸ªåä¸º "å¿ƒæµé™å²›" çš„AIæ•ˆèƒ½æ•™ç»ƒã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·çš„è¯­éŸ³è¾“å…¥ï¼Œå°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„æ—¥å†äº‹ä»¶ï¼Œå¹¶è¿›è¡Œâ€œæ—¶é—´ç®¡ç†å››è±¡é™â€åˆ†ç±»ã€‚ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. **è¾“å‡ºæ ¼å¼**: å¿…é¡»è¿”å›ä¸€ä¸ªJSONæ•°ç»„ã€‚æ¯ä¸ªå¯¹è±¡å¿…é¡»åŒ…å« \`time\` (HH:MMæ ¼å¼æˆ–'å¾…åŠ'), \`summary\` (8ä¸ªå­—ä»¥ä¸Šï¼Œä½†ä¸è¶…è¿‡16ä¸ªæ±‰å­—çš„æç®€æ‘˜è¦ï¼Œ**ä¸å«æ—¶é—´**), \`quadrant\` (æ•°å­—1-4), å’Œ \`start\` (ISO 8601æ ¼å¼)ã€‚ç»å¯¹ç¦æ­¢è¿”å›ä»»ä½•è§£é‡Šæˆ–Markdownã€‚
2. **æ—¶é—´å¼ºåˆ¶**: \`time\`å­—æ®µå¿…é¡»å­˜åœ¨ã€‚è‹¥è¯­éŸ³æ— æ˜ç¡®æ—¶é—´ï¼Œå›ºå®šè¿”å›å­—ç¬¦ä¸² "å¾…åŠ"ã€‚
3. **æ‘˜è¦æç®€**: \`summary\`å¿…é¡»æ˜¯â€œåŠ¨è¯+å¯¹è±¡â€çš„æ ¸å¿ƒä¿¡æ¯ï¼Œåˆ é™¤æ‰€æœ‰ä¿®é¥°è¯­ã€‚
4. **æ—¶é—´è§£æ**: æ ¹æ®å½“å‰æ—¶é—´ï¼ˆå‡è®¾ä¸º ${new Date().toISOString()}ï¼‰æ¨æ–­æœ€åˆç†çš„æœªæ¥å…·ä½“æ—¶é—´ã€‚å¯¹äºâ€œå¾…åŠâ€äº‹é¡¹ï¼Œå°†\`start\`è®¾ç½®ä¸ºå½“å¤©çš„å¼€å§‹ã€‚
5. **å¤šä»»åŠ¡æ‹†åˆ†**: å°†è¯­éŸ³ä¸­çš„å¤šä¸ªæ—¥ç¨‹æ‹†åˆ†æˆç‹¬ç«‹çš„JSONå¯¹è±¡ã€‚`,
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    time: { type: Type.STRING },
                                    summary: { type: Type.STRING },
                                    quadrant: { type: Type.INTEGER },
                                    start: { type: Type.STRING }
                                },
                                required: ['time', 'summary', 'quadrant', 'start']
                            }
                        }
                    }
                });
                const response = await withTimeout(aiPromise, 60000, 'AI è¯·æ±‚è¶…æ—¶ã€‚');
                const newTasks = JSON.parse(response.text.trim());
                if (!newTasks || newTasks.length === 0) { throw new Error('AI æœªèƒ½è¯†åˆ«æœ‰æ•ˆæ—¥ç¨‹ã€‚'); }
                
                const existingTasks = loadTasksFromStorage();
                const tasksWithIds = newTasks.map(task => ({ ...task, id: `task-${Date.now()}-${Math.random()}` }));
                
                const combinedTasks = [...existingTasks];
                tasksWithIds.forEach(newTask => {
                    if (!combinedTasks.some(existing => existing.summary === newTask.summary && existing.start === newTask.start)) {
                        combinedTasks.push(newTask);
                    }
                });

                taskWarehouse = combinedTasks;
                saveTasksToStorage(taskWarehouse);
                await updateUIAndSync(taskWarehouse);

            } catch (err) {
                updateStatus(`é”™è¯¯: ${err.message}`, true);
            } finally {
                updateButtonState('ç‚¹å‡»å¼€å§‹å½•éŸ³');
            }
        }

        async function sendImageToServer(imageBlob) {
            const fetchPromise = fetch('/api/image', {
                method: 'POST',
                headers: { 'Content-Type': 'image/png' },
                body: imageBlob
            });
            const response = await withTimeout(fetchPromise, 8000, 'æœåŠ¡å™¨è¿æ¥è¶…æ—¶ã€‚');
            if (!response.ok) { throw new Error(`æœåŠ¡å™¨è¿æ¥å¤±è´¥ (çŠ¶æ€: ${response.status})`); }
        }

        function handleRecordClick() {
            if (!recognition || !ai) return;

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Could not start recognition:", e);
                    updateStatus(`è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥: ${e.message}`, true);
                }
            }
        }

        function initialize() {
            if (!process.env.API_KEY) {
                updateStatus('é”™è¯¯: API_KEY æœªè®¾ç½®ã€‚', true);
                updateButtonState('AI OFFLINE', true);
                return;
            }
            ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true; // <-- CORE CHANGE: Enable continuous listening
                recognition.interimResults = false;
                recognition.lang = 'zh-CN';
                
                recognition.onstart = () => {
                    isRecording = true;
                    finalTranscript = '';
                    updateStatus('æ­£åœ¨è†å¬...');
                    updateButtonState('æ­£åœ¨è†å¬... (ç‚¹å‡»åœæ­¢)', false, true);
                    recordingTimeoutId = setTimeout(() => {
                        if (isRecording) {
                            recognition.stop();
                        }
                    }, 60000); // 60-second timeout
                };
                
                // CORE CHANGE: Accumulate results instead of taking just the first one.
                recognition.onresult = (event) => {
                    let interim_transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interim_transcript += event.results[i][0].transcript;
                        }
                    }
                };

                recognition.onerror = (event) => {
                    isRecording = false;
                    if (recordingTimeoutId) clearTimeout(recordingTimeoutId);
                    // 'no-speech' is a common error when continuous is true, we can ignore it.
                    if (event.error !== 'no-speech') {
                         updateStatus(`è¯­éŸ³è¯†åˆ«é”™è¯¯: ${event.error}`, true);
                    }
                    updateButtonState('ç‚¹å‡»å¼€å§‹å½•éŸ³');
                };

                recognition.onend = () => {
                    isRecording = false;
                    if (recordingTimeoutId) clearTimeout(recordingTimeoutId);
                    
                    if (recordButton.disabled) return;
                    
                    updateButtonState('æ­£åœ¨å¤„ç†...', true);
                    if (finalTranscript && finalTranscript.trim()) {
                        processTranscript(finalTranscript);
                    } else {
                        updateStatus('æœªæ£€æµ‹åˆ°æœ‰æ•ˆè¯­éŸ³ã€‚');
                        updateButtonState('ç‚¹å‡»å¼€å§‹å½•éŸ³');
                    }
                };
                
                recordButton.addEventListener('click', handleRecordClick);

            } else {
                updateButtonState('æµè§ˆå™¨ä¸æ”¯æŒ', true);
                updateStatus('é”™è¯¯: æµè§ˆå™¨ä¸æ”¯æŒç½‘é¡µè¯­éŸ³ APIã€‚', true);
                addMicrophonePermission();
            }

            clearAgendaButton.addEventListener('click', () => {
                if (confirm('æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥ç¨‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    taskWarehouse = [];
                    saveTasksToStorage([]);
                    updateUIAndSync([]);
                    updateStatus('æ‰€æœ‰æ—¥ç¨‹å·²æ¸…ç©ºã€‚');
                }
            });

            agendaGridContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-button')) {
                    const taskIdToDelete = event.target.dataset.taskId;
                    taskWarehouse = taskWarehouse.filter(task => task.id !== taskIdToDelete);
                    saveTasksToStorage(taskWarehouse);
                    updateUIAndSync(taskWarehouse);
                    updateStatus('ä¸€æ¡æ—¥ç¨‹å·²åˆ é™¤ã€‚');
                }
            });
            
            taskWarehouse = loadTasksFromStorage();
            updateUIAndSync(taskWarehouse);
            generateShowcase();
        }

        function generateShowcase() {
            Object.entries(personaData).forEach(([key, data]) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h2>${data.name}</h2>
                    <div class="persona-card" style="align-items: start;">
                        <div class="device-preview" style="position: static; width: 200px; height: 200px;">
                             <canvas id="canvas-${key}" width="200" height="200"></canvas>
                        </div>
                        <div id="showcase-list-${key}"></div>
                    </div>
                `;
                showcaseContainer.appendChild(card);
                const canvas = document.getElementById(`canvas-${key}`);
                renderImageOnCanvas(canvas, data.tasks);

                const listContainer = document.getElementById(`showcase-list-${key}`);
                listContainer.innerHTML = `
                    <p class="status-text" style="margin-top:0;">AIä¸ºå…¶è§„åˆ’çš„ä»Šæ—¥è¦åŠ¡ï¼š</p>
                    <ul class="agenda-list" style="font-size: 13px;">
                        ${data.tasks.map(t => `<li class="agenda-item"><span class="agenda-item-text"><span class="time">${t.time}</span> ${t.summary}</span></li>`).join('')}
                    </ul>
                `;
            });
        }
        
        function addMicrophonePermission() {
            const metadata = {
              "requestFramePermissions": [
                "microphone"
              ]
            };
            const metadataStr = JSON.stringify(metadata);
            const script = document.createElement('script');
            script.type = 'application/json';
            script.id = 'web-sdk-metadata';
            script.textContent = metadataStr;
            document.head.appendChild(script);
        }

        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>