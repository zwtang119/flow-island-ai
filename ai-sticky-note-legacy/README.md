
# AI 便利贴 for Watchy (DOS Edition)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Status](https://img.shields.io/badge/Status-Stable-green.svg)](#)

一个自托管的Web应用，可将语音备忘录或日历事件通过AI总结，并以复古DOS风格便利贴的形式，无线同步到您的 Watchy 电子墨水屏手表上。

该项目旨在解决一个特定问题：如何快速、无输入地将临时想法或即将到来的日程，同步到一个低功耗、始终在线的个人设备上。

---

### ✨ 核心特性

- **语音输入与AI摘要**: 通过浏览器录制语音，由 Gemini AI 自动总结为适合屏幕阅读的简短文本。
- **📅 无感日程同步**: 可选配置日历 `.ics` 订阅链接。本地服务器会自动拉取即将到来的日程，通过 AI 摘要后，主动更新到手表屏幕上。
- **动态图像生成**: 无论是语音备忘录还是日历事件，系统都会生成一张完整的200x200像素PNG图像，规避了在嵌入式设备上处理复杂字体的技术难题。
- **无线OTA更新**: 生成的便利贴图像通过本地Wi-Fi网络，以空中下载(OTA)的方式同步至手表。
- **自托管与隐私**: 所有组件（Web UI、服务器）均在本地网络运行，确保语音和备忘录数据不会离开私有环境。
- **所见即所得 (WYSIWYG)**: 采用全图像渲染技术，确保手表上的显示效果与Web UI中的预览完全一致。

---

### ⚙️ 系统架构

本项目采用一个“拉取(Pull)”模型，由多个组件协同工作：

`[ Calendar (.ics) ] ➔ [ 2. Local Server (Agent) ] ➔ [ Image Cache ]`
`[ User ] ➔ [ 1. Web UI (Voice & Setup) ] ➔ [ 2. Local Server (Agent) ] ➔ [ Image Cache ]  ↩ [ 3. Watchy Device ]`

1.  **Web UI (`index.html`)**:
    *   **职责**:
        *   提供一次性的日历 `.ics` 订阅链接配置界面。
        *   捕获音频输入，调用 Gemini API，在 HTML `<canvas>` 上绘制一张包含时钟和备忘录的200x200像素PNG图像。
    *   **动作**: 将**语音生成**的图像数据以 `POST` 请求发送到本地服务器。

2.  **本地服务器 (`server.js`)**:
    *   **职责**:
        *   作为一个轻量级的、**有状态的智能代理**。
        *   在后台**定时轮询**用户配置的日历链接，获取即将发生的事件。
        *   调用 Gemini API **摘要日程**，并使用 `node-canvas` **在服务器端生成**新的便利贴图像。
        *   在内存中缓存最新一张便利贴图像（无论是来自语音备忘录还是日历）。
    *   **设计原因**: 服务器的主动处理能力是实现“无感”日程同步的关键。

3.  **Watchy 设备 (固件)**:
    *   **职责**: 根据预设的时间间隔（例如，每15分钟）从深度睡眠中唤醒。
    *   **动作**: 通过Wi-Fi向本地服务器发起一个 `GET` 请求，拉取最新的屏幕图像，将其直接显示在电子墨水屏上，然后再次进入深度睡眠以优化功耗。

---

### 📖 设计原则

本项目的技术选型遵循以下原则：

- **部署与维护的简易性 (Simplicity)**
  项目前端从 React/TypeScript (v1.0.0) 重构为单个零依赖的 `index.html` (v2.0.0)，本地服务器也仅依赖少量核心NPM包。v4.0.0 架构进一步简化了固件，移除了所有字体渲染逻辑，使其只负责图像显示。这使得整个系统的部署过程无需复杂的构建工具或环境配置。

- **设计的可靠性 (Reliability)**
  v5.1.0 架构将“无感”功能的图像生成任务完全移至服务器端，避免了依赖用户打开浏览器。固件中集成的硬件看门狗(WDT)等机制，确保设备在软件挂起时能够自动恢复。

- **文档的完整性 (Clarity)**
  我们认为清晰、详尽的文档与代码同等重要。指南文档 (`GUIDE.md`) 包含了从环境配置到常见故障（如防火墙、浏览器安全策略、库版本冲突）的解决方案。

---

### 🚀 **快速开始**

请参阅以下分步指南以完成项目的安装与部署：

### ➡️ **[安装与部署指南](../../4-docs/guides/01-server-setup.md)**

---

### 🛠️ 技术栈

- **前端**: HTML, CSS, JavaScript (零依赖)
- **AI 服务**: Google Gemini API
- **本地服务器**: Node.js, Express, Sharp, node-canvas, ical
- **手表固件**: C++ (Arduino Framework for ESP32)

---

### ❓ 常见问题 (FAQ)

**Q: 为什么手表上的时钟不是实时更新的？**
**A:** 这是为了最大化电池续航并确保显示可靠性而做出的设计决策。系统会即时将带有当前时间的图像发送到本地服务器。但Watchy设备为优化功耗，大部分时间处于深度睡眠状态，并按固件中设定的唤醒周期（例如15分钟）联网更新。因此，手表上显示的时间是上次成功同步时的时间。

**Q: 生成多张便利贴是否会占用服务器存储空间？**
**A:** 不会。服务器被设计为无状态的，它只在内存中缓存最新的一张图像。每次新图像的同步请求都会覆盖前一张，因此存储占用是恒定的。

**Q: Web UI显示 `ERROR: not-allowed`，无法使用麦克风。**
**A:** 这是由现代浏览器的安全模型决定的。为保护用户隐私，浏览器只允许在安全上下文（`https://` 或 `localhost`）中使用麦克风。解决方案是在运行服务器的同一台计算机上，通过 `http://localhost:3000` 地址访问Web UI。

---

### 📝 更新日志

项目的版本更新历史和变更详情，请参阅独立的日志文件：

### ➡️ **[更新日志 (Changelog)](../../4-docs/changelog-archive/0-legacy-v4.md)
